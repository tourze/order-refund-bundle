# order-refund-bundle 完全解耦重构需求

## 1. 概述

### 1.1 背景
order-refund-bundle 需要实现完全的独立性，移除对 order-core-bundle 的任何直接依赖，包括 `OrderCoreBundle\Entity\Contract` 实体。通过纯数据快照模式实现售后功能，确保模块的完全独立和可复用性。

### 1.2 目标
- 完全移除对 order-core-bundle 的依赖
- 实现纯数据快照的售后系统
- 通过 referenceNumber 和数据传递实现关联
- 创建完全独立的售后处理引擎

### 1.3 架构定位
重构为 `order-refund-bundle`，完全独立的售后处理模块，可用于任何需要售后功能的场景。

## 2. 功能需求（EARS格式）

### 2.1 数据存储需求

#### R-001: 售后商品快照存储
- **普遍性**：包必须创建 `AftersalesProduct` 实体，独立存储售后商品信息
- **事件驱动**：当创建售后申请时，包必须从订单商品复制数据到售后商品表
- **状态驱动**：当查询售后详情时，包必须从本地快照读取，不依赖订单模块

#### R-002: 售后价格信息存储
- **普遍性**：包必须在 `AftersalesProduct` 中存储完整的价格信息（原价、实付价、优惠金额等）
- **条件性**：如果订单商品价格发生变化，售后记录必须保持创建时的价格快照
- **事件驱动**：当计算退款金额时，包必须使用售后表中的价格数据

#### R-003: 引用号关联机制
- **普遍性**：包必须使用 `referenceNumber` 字段关联订单，而非直接外键
- **状态驱动**：当需要获取订单信息时，包必须通过 referenceNumber 查询
- **条件性**：如果找不到对应订单，包必须能够独立显示售后信息

### 2.2 完全独立需求

#### R-004: 移除 order-core-bundle 依赖
- **普遍性**：包必须从 composer.json 中完全移除 `tourze/order-core-bundle` 依赖
- **条件性**：如果需要订单相关数据，必须通过参数传递获取
- **事件驱动**：当需要与订单模块通信时，必须通过事件系统实现

#### R-005: 纯数据传递机制
- **普遍性**：包必须通过纯数据结构（数组或DTO）接收订单和商品信息
- **状态驱动**：当创建售后时，必须将所有数据保存到本地存储
- **条件性**：如果传入数据不完整，必须抛出明确的验证错误

### 2.3 数据接口需求

#### R-006: 订单数据接口
- **普遍性**：包必须定义标准的订单数据结构，用于创建售后
- **事件驱动**：当调用者传入订单数据时，必须包含以下字段：
  - 订单编号 (orderNumber)
  - 订单状态 (orderStatus) 
  - 订单创建时间 (orderCreatedAt)
  - 用户ID (userId)
  - 订单总金额 (totalAmount)
- **条件性**：如果数据结构不完整，必须抛出验证异常

#### R-007: 商品数据接口
- **普遍性**：包必须定义标准的商品数据结构，用于创建售后商品
- **事件驱动**：当传入商品数据时，必须包含以下字段：
  - 商品ID (productId)
  - SKU ID (skuId)
  - 商品名称 (productName)
  - SKU名称 (skuName)
  - 原价 (originalPrice)
  - 实付价 (paidPrice)
  - 优惠金额 (discountAmount)
  - 订单数量 (orderQuantity)
  - 商品属性 (attributes)
- **状态驱动**：当创建售后时，必须验证所有必要字段存在

### 2.4 扩展机制需求

#### R-008: 售后类型扩展
- **普遍性**：包必须提供售后类型注册机制，允许注册自定义售后类型
- **事件驱动**：当注册新的售后类型时，包必须自动加载相应的处理器
- **条件性**：如果售后类型未注册，包必须使用默认处理器或抛出异常

#### R-009: 规则引擎接口
- **普遍性**：包必须提供 `AftersalesRuleEngineInterface`，允许自定义售后规则
- **状态驱动**：当评估售后申请时，包必须调用规则引擎进行验证
- **条件性**：如果规则验证失败，包必须拒绝售后申请并返回失败原因

#### R-010: 工作流扩展
- **普遍性**：包必须提供 `AftersalesWorkflowInterface`，支持自定义售后流程
- **事件驱动**：当售后状态变更时，包必须触发工作流事件
- **可选性**：在使用自定义工作流的情况下，包必须遵循自定义的状态转换规则

### 2.5 事件系统需求

#### R-011: 售后生命周期事件
- **事件驱动**：当售后申请创建时，包必须发布 `AftersalesCreatedEvent`
- **事件驱动**：当售后状态变更时，包必须发布 `AftersalesStatusChangedEvent`
- **事件驱动**：当售后完成时，包必须发布 `AftersalesCompletedEvent`

#### R-012: 业务集成事件
- **普遍性**：包必须提供 `AftersalesEntityRequestEvent`，请求业务实体信息
- **事件驱动**：当需要业务实体信息时，包必须发布该事件并等待响应
- **条件性**：如果事件无响应，包必须使用默认值或抛出异常

### 2.6 数据模型需求

#### R-013: 售后申请实体
- **普遍性**：包必须提供 `Aftersales` 实体，包含 `referenceNumber` 字段作为外部关联
- **条件性**：如果需要订单信息，必须通过本地存储的数据快照获取
- **状态驱动**：当查询售后申请时，包必须支持按 referenceNumber 过滤

#### R-014: 售后商品实体
- **普遍性**：包必须提供 `AftersalesProduct` 实体，存储商品快照信息
- **事件驱动**：当创建售后时，必须包含以下字段：
  - 商品ID (productId)
  - SKU信息 (skuId, skuName)
  - 商品名称 (productName)
  - 原价 (originalPrice)
  - 实付价 (paidPrice)
  - 数量 (quantity)
  - 退款数量 (refundQuantity)
  - 退款金额 (refundAmount)
  - 优惠信息 (discountAmount)
- **状态驱动**：当计算退款时，必须使用本地存储的价格信息

#### R-015: 订单信息实体
- **普遍性**：包必须提供 `AftersalesOrder` 实体，存储订单信息快照
- **事件驱动**：当创建售后时，必须存储以下订单信息：
  - 订单编号 (orderNumber)
  - 订单状态 (orderStatus)
  - 订单创建时间 (orderCreatedAt) 
  - 用户ID (userId)
  - 订单总金额 (totalAmount)
- **状态驱动**：当查询售后详情时，必须显示完整的订单信息快照

### 2.7 数据完整性需求

#### R-016: 历史数据保护
- **普遍性**：包必须确保售后记录创建后，商品和价格信息不可变更
- **条件性**：如果需要修改售后信息，必须创建新的版本记录
- **状态驱动**：当售后完成后，必须锁定所有相关数据

#### R-017: 数据一致性保证
- **事件驱动**：当创建售后时，必须在事务中完成所有数据复制
- **条件性**：如果数据复制失败，必须回滚整个售后创建操作
- **普遍性**：包必须提供数据完整性校验机制

## 3. 非功能需求

### 3.1 性能需求

#### NFR-001: 查询性能
- **普遍性**：包必须确保售后查询响应时间小于 100ms
- **条件性**：如果查询涉及多表关联，包必须使用适当的索引优化

#### NFR-002: 并发处理
- **普遍性**：包必须支持并发售后申请处理，避免数据竞争
- **状态驱动**：当检测到并发冲突时，包必须使用乐观锁或悲观锁机制

### 3.2 可扩展性需求

#### NFR-003: 插件化架构
- **普遍性**：包必须采用插件化架构，支持功能扩展
- **可选性**：在加载插件的情况下，包必须验证插件兼容性

#### NFR-004: 配置化规则
- **普遍性**：包必须支持通过配置文件定义售后规则
- **条件性**：如果配置文件不存在，包必须使用默认规则

### 3.3 可维护性需求

#### NFR-005: 代码质量
- **普遍性**：包必须通过 PHPStan Level 8 检查，零错误
- **普遍性**：包必须达到 90% 以上的测试覆盖率

#### NFR-006: 文档完整性
- **普遍性**：包必须提供完整的接口文档和集成指南
- **事件驱动**：当接口变更时，包必须同步更新文档

## 4. 集成需求

### 4.1 框架集成

#### INT-001: Symfony Bundle 集成
- **普遍性**：包必须作为标准 Symfony Bundle 提供自动配置
- **条件性**：如果检测到 Symfony 环境，包必须自动注册服务

#### INT-002: Doctrine ORM 集成
- **普遍性**：包必须提供 Doctrine 实体映射
- **可选性**：在使用其他 ORM 的情况下，包必须提供适配器接口

### 4.2 服务集成

#### INT-003: 消息队列集成
- **可选性**：在配置消息队列的情况下，包必须支持异步处理售后申请
- **事件驱动**：当使用异步模式时，包必须发布消息到队列

#### INT-004: 缓存集成
- **可选性**：在配置缓存的情况下，包必须缓存售后规则和配置
- **状态驱动**：当规则更新时，包必须自动清除相关缓存

## 5. 验收标准

### 5.1 功能验收

- [ ] 完全移除 order-core-bundle 依赖
- [ ] 实现纯数据传递的售后创建机制
- [ ] 独立存储所有订单和商品信息快照
- [ ] 支持基于 referenceNumber 的关联查询
- [ ] 实现仅退款和退货退款两种售后类型

### 5.2 性能验收

- [ ] 查询响应时间 < 100ms
- [ ] 支持每秒 100 个并发售后申请
- [ ] 内存占用不超过 128MB

### 5.3 质量验收

- [ ] PHPStan Level 8 零错误
- [ ] 测试覆盖率 ≥ 90%
- [ ] 文档覆盖所有公共 API
- [ ] 提供完整的迁移指南

### 5.4 兼容性验收

- [ ] 现有功能完全兼容
- [ ] 提供平滑升级路径
- [ ] 支持 PHP 8.1+
- [ ] 支持 Symfony 6.4+

## 6. 实施计划建议

### Phase 1: 接口设计（第1-2周）
1. 设计并实现核心接口
2. 创建接口文档
3. 编写接口测试

### Phase 2: 核心重构（第3-4周）
1. 实现通用售后实体
2. 实现事件系统
3. 实现规则引擎

### Phase 3: 适配器开发（第5周）
1. 开发订单适配器
2. 实现向后兼容层
3. 编写迁移脚本

### Phase 4: 测试与优化（第6周）
1. 完整测试覆盖
2. 性能优化
3. 文档完善

### Phase 5: 迁移与部署（第7周）
1. 数据迁移
2. 灰度发布
3. 监控与调优

## 7. 风险与缓解

### 7.1 技术风险
- **风险**：接口设计不够通用，无法覆盖所有场景
- **缓解**：进行充分的需求调研，设计可扩展的接口

### 7.2 兼容性风险
- **风险**：破坏现有功能
- **缓解**：提供完整的适配器层，保证向后兼容

### 7.3 性能风险
- **风险**：抽象层增加性能开销
- **缓解**：使用缓存和优化查询，进行性能测试

## 8. 成功指标

1. **技术指标**：
   - 完全移除 order-core-bundle 依赖
   - 实现纯数据传递的售后系统
   - 可独立部署和测试

2. **质量指标**：
   - PHPStan Level 8 通过
   - 测试覆盖率 > 90%
   - 零关键 bug

3. **业务指标**：
   - 售后数据完整性 100%
   - 模块复用性提升 100%
   - 系统耦合度降低 80%